<form class="flexcol {{cssClass}} {{#if isDying}}dying{{/if}}" autocomplete="off">
    
    <div class="item-bg" style="background-image: url('{{data.img}}');"></div>
    {{!-- Sheet Header --}}
    <header class="sheet-header">
        <!--<div class="header-top-container">
        </div>-->

        <div class="header-main-container">
            <div class="resource health">
                <div class="resource-content">
                    <div class="resource-box">
                        <input type="number" name="system.health.value" value="{{systemData.health.value}}" min="0" max="{{systemData.health.max}}" />
                        <span>/</span>
                        <input type="number" name="system.health.max" value="{{systemData.health.max}}" min="0" />
                    </div>
                </div>
                <div class="resource-label-controls">
                    <a class="resource-control" data-action="decrement" data-field="health.value"><i class="fas fa-minus"></i></a>
                    <label data-trait-tooltip="{{systemData.health.tooltip}}">{{localize "DH.HitPoints"}}</label>
                    <a class="resource-control" data-action="increment" data-field="health.value"><i class="fas fa-plus"></i></a>
                </div>
            </div>

            <div class="portrait-container">
                <div class="portrait-buttons">
                    <button type="button" class="rest-button short-rest" data-rest-type="short" title="{{localize 'DH.ShortRest'}}">
                        <i class="fas fa-hourglass-half"></i>
                    </button>
                    <button type="button" class="rest-button long-rest" data-rest-type="long" title="{{localize 'DH.LongRest'}}">
                        <i class="fas fa-bed"></i>
                    </button>
                </div>
                <div class="portrait-image-wrapper">
                    <img class="profile-img" src="{{data.img}}" data-edit="img" title="{{data.name}}" />
                    {{#if isDying}}
                    <div class="death-overlay" title="Character is dying!">
                        <i class="fas fa-skull"></i>
                    </div>
                    {{/if}}
                </div>

                <div class="portrait-resources">
                    <div class="resource hope">
                        <div class="resource-content">
                            <div class="resource-box">
                                <input type="number" name="system.hope.value" value="{{systemData.hope.value}}" min="0" max="{{systemData.hope.max}}" />
                                <span>/</span>
                                <input type="number" name="system.hope.max" value="{{systemData.hope.max}}" min="0" />
                            </div>
                        </div>
                        <div class="resource-label-controls">
                            <a class="resource-control" data-action="decrement" data-field="hope.value"><i class="fas fa-minus"></i></a>
                            <label data-trait-tooltip="{{systemData.hope.tooltip}}">{{localize "DH.Hope"}}</label>
                            <a class="resource-control" data-action="increment" data-field="hope.value"><i class="fas fa-plus"></i></a>
                        </div>
                    </div>
                    <div class="resource armor-slots">
                        <div class="resource-content">
                            <div class="resource-box">
                                <input type="number" name="system.defenses.armor-slots.value" value="{{systemData.defenses.armor-slots.value}}" min="0" max="{{systemData.defenses.armor.value}}" />
                                <span>/</span>
                                <input type="number" value="{{systemData.defenses.armor.value}}" min="0" readonly disabled title="Edit armor value in the defense section" />
                            </div>
                        </div>
                        <div class="resource-label-controls">
                            <a class="resource-control" data-action="decrement" data-field="defenses.armor-slots.value"><i class="fas fa-minus"></i></a>
                            <label>{{localize "DH.ArmorSlots"}}</label>
                            <a class="resource-control" data-action="increment" data-field="defenses.armor-slots.value"><i class="fas fa-plus"></i></a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="resource stress">
                <div class="resource-content">
                    <div class="resource-box">
                        <input type="number" name="system.stress.value" value="{{systemData.stress.value}}" min="0" max="{{systemData.stress.max}}" />
                        <span>/</span>
                        <input type="number" name="system.stress.max" value="{{systemData.stress.max}}" min="0" />
                    </div>
                </div>
                <div class="resource-label-controls">
                    <a class="resource-control" data-action="decrement" data-field="stress.value"><i class="fas fa-minus"></i></a>
                    <label data-trait-tooltip="{{systemData.stress.tooltip}}">{{localize "DH.Stress"}}</label>
                    <a class="resource-control" data-action="increment" data-field="stress.value"><i class="fas fa-plus"></i></a>
                </div>
            </div>
        </div>

        <div class="header-bottom-container">
            <h1 class="charname">
                <input name="name" type="text" value="{{data.name}}" placeholder="{{localize "DH.Name"}}" />
            </h1>
            <!--<div class="header-name-level-prof">
                <!--<div class="charlevel">
                    <input type="number" name="system.level.value" value="{{systemData.level.value}}" />
                    <a>{{localize "DH.Level"}}</a>
                </div>-->
                
                <!--<div class="charlevel">
                    <input id="prof" type="number" name="system.proficiency.value" value="{{systemData.proficiency.value}}" />
                    <a>{{localize "DH.Prof"}}</a>
                </div>
            </div>-->

            <div class="header-domain">
                <input type="text" name="system.chosenDomains.domain-one" value="{{systemData.chosenDomains.domain-one}}"
                    placeholder="{{localize "DH.DomainOne"}}" />
                <input type="text" name="system.chosenDomains.domain-two" value="{{systemData.chosenDomains.domain-two}}"
                    placeholder="{{localize "DH.DomainTwo"}}" />
            </div>
        </div>
    </header>
    
    {{!-- Trait Edit Popup (backwards compatibility) --}}
    <div class="trait-edit-popup-overlay" style="display: none;">
        <div class="trait-edit-popup">
            <div class="trait-edit-header">
                <span class="trait-edit-label"></span>
                <button type="button" class="trait-edit-close">Ã—</button>
            </div>
            <div class="trait-edit-content">
                <div class="trait-base-value">
                    <label>Base Value</label>
                    <input type="number" class="trait-base-input" />
                </div>
                <div class="trait-modifiers-section">
                    <div class="modifiers-header">
                        <span>Modifiers</span>
                        <button type="button" class="add-modifier-btn">+</button>
                    </div>
                    <div class="modifiers-list"></div>
                </div>
                <div class="trait-total">
                    <label>Total</label>
                    <span class="trait-total-value">0</span>
                </div>
            </div>
        </div>
    </div>
    
    {{!-- Sheet Tab Navigation --}}
    <!-- CASE SENSITIVE! -->
    <nav class="sheet-tabs tabs" data-group="primary">
        <a class="item active" data-tab="character">{{localize "DH.Character"}}</a>
        <a class="item" data-tab="equipment">{{localize "DH.Equipment"}}</a>
        <div class="nav-gem"></div>
        <a class="item" data-tab="loadout">{{localize "DH.Loadout"}}</a>
        <a class="item" data-tab="biography">{{localize "DH.Biography"}}</a>
    </nav>
    
    {{!-- Sheet Body --}}
    <section class="sheet-body">
        
        <div class="tab character" data-group="primary" data-tab="character">
            <section class="character-main-section">

                <section class="defenses">
                    <div class="advancement-group">
                        <label>{{localize "DH.Advancement"}}</label>
                        <div class="advancement-values">
                            <div class="resource-group">
                                <input type="number" name="system.level.value"
                                    value="{{systemData.level.value}}" />
                                <a class="trait-effects">{{localize "DH.Level"}}</a>
                            </div>
                            <div class="resource-group">
                                <input type="number" name="system.proficiency.value"
                                    value="{{systemData.proficiency.value}}" />
                                <a class="trait-effects">{{localize "DH.Prof"}}</a>
                            </div>
                        </div>
                    </div>

                    <div class="defense-group">
                        <div class="defense" data-defense="armor">
                            <div class="attribute-value-display defense-value-display" 
                                 data-field="system.defenses.armor.value"
                                 data-label="Armor"
                                 data-has-modifiers="true"
                                 data-min="0">{{systemData.defenses.armor.value}}</div>
                            <div class="armor-controls">
                                <label data-trait-tooltip="{{systemData.defenses.armor.tooltip}}">{{localize "DH.Armor"}}</label>
                            </div>
                        </div>
                        <div class="defense" data-defense="evasion">
                            <div class="attribute-value-display defense-value-display" 
                                 data-field="system.defenses.evasion.value"
                                 data-label="Evasion"
                                 data-has-modifiers="true"
                                 data-min="0">{{systemData.defenses.evasion.value}}</div>
                            <label data-trait-tooltip="{{systemData.defenses.evasion.tooltip}}">{{localize "DH.Evasion"}}</label>
                        </div>
                    </div>

                    <div class="threshold-group">
                        <label>{{localize "DH.Threshold"}}</label>
                        <div class="threshold-values">
                            <span class="threshold-text threshold-clickable" data-action="mark-hp" data-hp-amount="1">{{localize "DH.Mark1HP"}}</span>
                            <div class="resource-group">
                                <input type="number" name="system.threshold.minor"
                                    value="{{systemData.threshold.minor}}" />
                                <a class="trait-effects">{{localize "DH.Major"}}</a>
                            </div>
                            <span class="threshold-text threshold-clickable" data-action="mark-hp" data-hp-amount="2">{{localize "DH.Mark2HP"}}</span>
                            <div class="resource-group">
                                <input type="number" name="system.threshold.major"
                                    value="{{systemData.threshold.major}}" />
                                <a class="trait-effects">{{localize "DH.Severe"}}</a>
                            </div>
                            <span class="threshold-text threshold-clickable" data-action="mark-hp" data-hp-amount="3">{{localize "DH.Mark3HP"}}</span>
                        </div>
                    </div>
                </section>

                <section class="traits">
                    <div class="trait" data-trait="agility">
                        <div class="trait-label-wrapper">
                            <label for="system.agility.value" data-trait-tooltip="{{systemData.agility.tooltip}}"><i class="fas fa-dice-d12 trait-d12-icon"></i>{{localize "DH.Agility"}}</label>
                        </div>
                        <div class="trait-value-display" data-field="system.agility.value">{{systemData.agility.value}}</div>
                        <div class="trait-toggle">
                            <input type="checkbox" name="system.agility.levelled" {{#if systemData.agility.levelled}}checked{{/if}} />
                        </div>
                        <div class="trait-effects">
                            <a>{{localize "DH.Sprint"}}</a>
                            <a>{{localize "DH.Dodge"}}</a>
                            <a>{{localize "DH.Leap"}}</a>
                        </div>
                    </div>
                    <div class="trait" data-trait="strength">
                        <div class="trait-label-wrapper">
                            <label for="system.strength.value" data-trait-tooltip="{{systemData.strength.tooltip}}"><i class="fas fa-dice-d12 trait-d12-icon"></i>{{localize "DH.Strength"}}</label>
                        </div>
                        <div class="trait-value-display" data-field="system.strength.value">{{systemData.strength.value}}</div>
                        <div class="trait-toggle">
                            <input type="checkbox" name="system.strength.levelled" {{#if systemData.strength.levelled}}checked{{/if}} />
                        </div>
                        <div class="trait-effects">
                            <a>{{localize "DH.Lift"}}</a>
                            <a>{{localize "DH.Smash"}}</a>
                            <a>{{localize "DH.Grapple"}}</a>
                        </div>
                    </div>
                    <div class="trait" data-trait="finesse">
                        <div class="trait-label-wrapper">
                            <label for="system.finesse.value" data-trait-tooltip="{{systemData.finesse.tooltip}}"><i class="fas fa-dice-d12 trait-d12-icon"></i>{{localize "DH.Finesse"}}</label>
                        </div>
                        <div class="trait-value-display" data-field="system.finesse.value">{{systemData.finesse.value}}</div>
                        <div class="trait-toggle">
                            <input type="checkbox" name="system.finesse.levelled" {{#if systemData.finesse.levelled}}checked{{/if}} />
                        </div>
                        <div class="trait-effects">
                            <a>{{localize "DH.Control"}}</a>
                            <a>{{localize "DH.Hide"}}</a>
                            <a>{{localize "DH.Tinker"}}</a>
                        </div>
                    </div>
                    <div class="trait" data-trait="instinct">
                        <div class="trait-label-wrapper">
                            <label for="system.instinct.value" data-trait-tooltip="{{systemData.instinct.tooltip}}"><i class="fas fa-dice-d12 trait-d12-icon"></i>{{localize "DH.Instinct"}}</label>
                        </div>
                        <div class="trait-value-display" data-field="system.instinct.value">{{systemData.instinct.value}}</div>
                        <div class="trait-toggle">
                            <input type="checkbox" name="system.instinct.levelled" {{#if systemData.instinct.levelled}}checked{{/if}} />
                        </div>
                        <div class="trait-effects">
                            <a>{{localize "DH.Perceive"}}</a>
                            <a>{{localize "DH.Sense"}}</a>
                            <a>{{localize "DH.Navigate"}}</a>
                        </div>
                    </div>
                    <div class="trait" data-trait="presence">
                        <div class="trait-label-wrapper">
                            <label for="system.presence.value" data-trait-tooltip="{{systemData.presence.tooltip}}"><i class="fas fa-dice-d12 trait-d12-icon"></i>{{localize "DH.Presence"}}</label>
                        </div>
                        <div class="trait-value-display" data-field="system.presence.value">{{systemData.presence.value}}</div>
                        <div class="trait-toggle">
                            <input type="checkbox" name="system.presence.levelled" {{#if systemData.presence.levelled}}checked{{/if}} />
                        </div>
                        <div class="trait-effects">
                            <a>{{localize "DH.Charm"}}</a>
                            <a>{{localize "DH.Perform"}}</a>
                            <a>{{localize "DH.Deceive"}}</a>
                        </div>
                    </div>
                    <div class="trait" data-trait="knowledge">
                        <div class="trait-label-wrapper">
                            <label for="system.knowledge.value" data-trait-tooltip="{{systemData.knowledge.tooltip}}"><i class="fas fa-dice-d12 trait-d12-icon"></i>{{localize "DH.Knowledge"}}</label>
                        </div>
                        <div class="trait-value-display" data-field="system.knowledge.value">{{systemData.knowledge.value}}</div>
                        <div class="trait-toggle">
                            <input type="checkbox" name="system.knowledge.levelled" {{#if systemData.knowledge.levelled}}checked{{/if}} />
                        </div>
                        <div class="trait-effects">
                            <a>{{localize "DH.Recall"}}</a>
                            <a>{{localize "DH.Analyze"}}</a>
                            <a>{{localize "DH.Comprehend"}}</a>
                        </div>
                    </div>
                </section>

                <div class="experience-group">
                    <div class="experience-row click-rollable-group">
                        <div class="experience-row-column">
                            <div class="exp-level"><input type="number" name="system.experience.1level" value="{{systemData.experience.1level}}" placeholder="1" /></div>
                            <a class="trait-effects">{{localize "DH.Level"}}</a>  
                        </div>
                        <div class="experience-row-column-2">
                            <input class="click-rollable-name" name="system.experience.1Name" type="text"
                                value="{{systemData.experience.1Name}}" placeholder="{{localize "DH.Experience"}}" />
                        </div>
                        <div class="experience-row-column">
                            <input class="click-rollable-modifier" type="number" name="system.experience.1Mod"
                                value="{{systemData.experience.1Mod}}" />
                        </div>
                    </div>
                    <div class="experience-row click-rollable-group">
                        <div class="experience-row-column">
                            <div class="exp-level"><input type="number" name="system.experience.2level" value="{{systemData.experience.2level}}" placeholder="1"/></div>
                            <a class="trait-effects">{{localize "DH.Level"}}</a>
                        </div>
                        <div class="experience-row-column-2">
                            <input class="click-rollable-name" name="system.experience.2Name" type="text" value="{{systemData.experience.2Name}}" placeholder="{{localize "DH.Experience"}}"/>
                        </div>
                        <div class="experience-row-column">
                            <input class="click-rollable-modifier"type="number" name="system.experience.2Mod" value="{{systemData.experience.2Mod}}"/>
                        </div>
                    </div>
                    <div class="experience-row click-rollable-group">
                        <div class="experience-row-column">
                            <div class="exp-level"><input type="number" name="system.experience.5level" value="{{systemData.experience.5level}}" placeholder="2"/></div>
                            <a class="trait-effects">{{localize "DH.Level"}}</a>
                        </div>
                        <div class="experience-row-column-2">
                            <input class="click-rollable-name" name="system.experience.5Name" type="text" value="{{systemData.experience.5Name}}" placeholder="{{localize "DH.Experience"}}"/>
                        </div>
                        <div class="experience-row-column">
                            <input class="click-rollable-modifier"type="number" name="system.experience.5Mod" value="{{systemData.experience.5Mod}}"/>
                        </div>
                    </div>
                    <div class="experience-row click-rollable-group">
                        <div class="experience-row-column">
                            <div class="exp-level"><input type="number" name="system.experience.8level" value="{{systemData.experience.8level}}" placeholder="5"/></div>
                            <a class="trait-effects">{{localize "DH.Level"}}</a>
                        </div>
                        <div class="experience-row-column-2">
                            <input class="click-rollable-name" name="system.experience.8Name" type="text" value="{{systemData.experience.8Name}}" placeholder="{{localize "DH.Experience"}}"/>
                        </div>
                        <div class="experience-row-column">
                            <input class="click-rollable-modifier"type="number" name="system.experience.8Mod" value="{{systemData.experience.8Mod}}"/>
                        </div>
                    </div>
                    <div class="experience-row click-rollable-group">
                        <div class="experience-row-column">
                            <div class="exp-level"><input type="number" name="system.experience.11level" value="{{systemData.experience.11level}}" placeholder="8"/></div>
                            <a class="trait-effects">{{localize "DH.Level"}}</a>
                        </div>
                        <div class="experience-row-column-2">
                            <input class="click-rollable-name" name="system.experience.1Name2" type="text"
                                value="{{systemData.experience.1Name2}}" placeholder="{{localize "DH.Experience"}}" />
                        </div>
                        <div class="experience-row-column">
                            <input class="click-rollable-modifier" type="number" name="system.experience.1Mod2"
                                value="{{systemData.experience.1Mod2}}" />
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div class="tab biography" data-group="primary" data-tab="biography">
            <div class="tab-title">{{localize "DH.Biography"}}</div>

            <section class="character-main-section">                
                <div class="character-details">
                    <div class="char-detail-item">
                        <label>{{localize "DH.Age"}}</label>
                        <input type="text" name="system.age" value="{{systemData.age}}" />
                    </div>
                    <div class="char-detail-item">
                        <label>{{localize "DH.Pronouns"}}</label>
                        <input type="text" name="system.pronouns" value="{{systemData.pronouns}}" />
                    </div>
                    <div class="char-detail-item">
                        <label>{{localize "DH.Residence"}}</label>
                        <input type="text" name="system.residence" value="{{systemData.residence}}" />
                    </div>
                    <div class="char-detail-item">
                        <label>{{localize "DH.Nationality"}}</label>
                        <input type="text" name="system.nationality" value="{{systemData.nationality}}" />
                    </div>
                </div>

                {{editor biographyHTML target="system.biography" button=true editable=editable engine="prosemirror"}}
            </section>
        </div>

        <div class="tab equipment" data-group="primary" data-tab="equipment">
            <div class="tab-title">{{localize "DH.Equipment"}}</div>

            {{!-- Weapon Tab --}}
            <div class="weapons">
                <div class="weapon-group">
                    <div class="weapon-row">
                        <label class="weapon-label">{{localize "DH.PrimaryWeapon"}}</label>
                        <div class="weapon-box click-rollable-group basic-rollable-group">
                            <button type="button" class="weapon-attack-button click-rollable" data-roll-type="attack" title="Roll Attack">
                                <i class="fas fa-sword"></i>
                            </button>
                            <div class="weapon-box-inner">
                                <div class="weapon-infobox-first">
                                    <input class="weapon-field basic-rollable-name click-rollable-name"
                                        name="system.weapon-main.name" type="text"
                                        value="{{systemData.weapon-main.name}}" placeholder="{{localize "DH.Weapon"}}" />
                                        <div class="textarea-container">
                                            <input class="trait-effects resize-ta" name="system.weapon-main.description"
                                                placeholder="{{localize "DH.WeaponTraitsHere"}}"
                                                value="{{systemData.weapon-main.description}}" />
                                        </div>
                                </div>
                                <div class="weapon-roller-box">
                                    <div class="weapon-infobox">
                                        <div class="attribute-value-display weapon-modifier-display"
                                             data-field="system.weapon-main.to-hit"
                                             data-label="Primary Weapon Attack"
                                             data-has-modifiers="true">{{#if systemData.weapon-main.to-hit.value}}{{systemData.weapon-main.to-hit.value}}{{else}}0{{/if}}</div>
                                        <a class="trait-effects click-rollable" data-roll-type="attack">{{localize "DH.Modifier"}}</a>
                                    </div>
                                    <div class="weapon-infobox">
                                        <div class="weapon-damage-display damage-value-display"
                                             data-field="system.weapon-main.damage"
                                             data-label="Primary Weapon Damage"
                                             data-has-modifiers="true"
                                             data-edit-type="damage">{{#if systemData.weapon-main.damage.value}}{{systemData.weapon-main.damage.value}}{{else}}{{#if systemData.weapon-main.damage}}{{systemData.weapon-main.damage}}{{else}}1d8{{/if}}{{/if}}</div>
                                        <a class="trait-effects basic-rollable" data-roll-type="damage">{{localize "DH.Damage"}}</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="weapon-row">
                        <label class="weapon-label">{{localize "DH.SecondaryWeapon"}}</label>
                        <div class="weapon-box click-rollable-group basic-rollable-group">
                            <button type="button" class="weapon-attack-button click-rollable" data-roll-type="attack" title="Roll Attack">
                                <i class="fas fa-sword"></i>
                            </button>
                            <div class="weapon-box-inner">
                                <div class="weapon-infobox-first">
                                    <input class="weapon-field basic-rollable-name click-rollable-name"
                                        name="system.weapon-off.name" type="text"
                                        value="{{systemData.weapon-off.name}}" placeholder="{{localize "DH.Weapon"}}" />
                                        <div class="textarea-container">
                                            <input class="trait-effects resize-ta" name="system.weapon-off.description"
                                                placeholder="{{localize "DH.WeaponTraitsHere"}}"
                                                value="{{systemData.weapon-off.description}}" />
                                        </div>
                                </div>
                                <div class="weapon-roller-box">
                                    <div class="weapon-infobox">
                                        <div class="attribute-value-display weapon-modifier-display"
                                             data-field="system.weapon-off.to-hit"
                                             data-label="Secondary Weapon Attack"
                                             data-has-modifiers="true">{{#if systemData.weapon-off.to-hit.value}}{{systemData.weapon-off.to-hit.value}}{{else}}0{{/if}}</div>
                                        <a class="trait-effects click-rollable" data-roll-type="attack">{{localize "DH.Modifier"}}</a>
                                    </div>
                                    <div class="weapon-infobox">
                                        <div class="weapon-damage-display damage-value-display"
                                             data-field="system.weapon-off.damage"
                                             data-label="Secondary Weapon Damage"
                                             data-has-modifiers="true"
                                             data-edit-type="damage">{{#if systemData.weapon-off.damage.value}}{{systemData.weapon-off.damage.value}}{{else}}{{#if systemData.weapon-off.damage}}{{systemData.weapon-off.damage}}{{else}}1d8{{/if}}{{/if}}</div>
                                        <a class="trait-effects basic-rollable" data-roll-type="damage">{{localize "DH.Damage"}}</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                
            {{!-- Treasure Tracking Section --}}
            <div class="treasure-tracker">
                <div class="treasure-item">
                    <input type="number" name="system.treasure.coins.value" value="{{systemData.treasure.coins.value}}" 
                           title="{{systemData.treasure.coins.tooltip}}" min="0" />
                    <div class="treasure-icon">
                        <i class="fas fa-coins"></i>
                        <label>{{localize "DH.Coins"}}</label>
                    </div>
                </div>
                <div class="treasure-item">
                    <input type="number" name="system.treasure.handfuls.value" value="{{systemData.treasure.handfuls.value}}" 
                           title="{{systemData.treasure.handfuls.tooltip}}" min="0" />
                    <div class="treasure-icon">
                        <i class="fas fa-hand-holding"></i>
                        <label>{{localize "DH.Handfuls"}}</label>
                    </div>
                </div>
                <div class="treasure-item">
                    <input type="number" name="system.treasure.bags.value" value="{{systemData.treasure.bags.value}}" 
                           title="{{systemData.treasure.bags.tooltip}}" min="0" />
                    <div class="treasure-icon">
                        <i class="fas fa-shopping-bag"></i>
                        <label>{{localize "DH.Bags"}}</label>
                    </div>
                </div>
                <div class="treasure-item">
                    <input type="number" name="system.treasure.chests.value" value="{{systemData.treasure.chests.value}}" 
                           title="{{systemData.treasure.chests.tooltip}}" min="0" />
                    <div class="treasure-icon">
                        <i class="fas fa-treasure-chest"></i>
                        <label>{{localize "DH.Chests"}}</label>
                    </div>
                </div>
            </div>

            {{!-- Owned Inventory Tab --}}
            <div class="inventory">
                <div class="tab-category">{{localize "DH.Worn"}}
                    <div class="category-controls">
                        <a class="item-control" title="{{ localize 'SIMPLE.ItemCreate' }}" data-action="create-item"
                            data-type="worn">
                            <i class="fas fa-plus"></i></a>
                        <a class="item-control category-toggle" data-category="worn" title="Toggle Worn Section"><i class="fas fa-chevron-down"></i></a>
                    </div>
                </div>
                <ol class="item-list category-collapsed" data-item-type="worn">
                    {{#each data.items as |item id|}}
                    {{#if (eq item.type "worn")}}
                    <li class="item" data-item-id="{{item._id}}">
                        <div class="item-main-row">
                            <div class="item-top-row">
                                <img class="item-control" data-action="edit" src="{{item.img}}" title="{{item.name}}"
                                    width="30" height="30" />
                                <h4 class="item-name" data-action="toggle-description">{{item.name}}</h4>
                            </div>
                            <div class="item-controls">
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemEdit' }}" data-action="edit"><i
                                        class="fas fa-edit"></i></a>
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemDelete' }}" data-action="delete"><i
                                        class="fas fa-trash"></i></a>
                            </div>
                        </div>
                        <div class="item-description">
                            {{{item.system.enrichedDescription}}}
                        </div>
                    </li>
                    {{/if}}
                    {{/each}}
                </ol>

                <div class="tab-category">{{localize "DH.Backpack"}}
                    <div class="category-controls">
                        <a class="item-control" title="{{ localize 'SIMPLE.ItemCreate' }}" data-action="create-item"
                            data-type="inventory">
                            <i class="fas fa-plus"></i></a>
                        <a class="item-control category-toggle" data-category="backpack" title="Toggle Backpack Section"><i class="fas fa-chevron-down"></i></a>
                    </div>
                </div>

                <ol class="item-list category-collapsed" data-item-type="inventory">
                    {{#each data.items as |item id|}}
                    {{#if (eq item.type "inventory")}}
                    <li class="item" data-item-id="{{item._id}}">
                        <div class="item-main-row">
                            <div class="item-top-row">
                                <img class="item-control" data-action="edit" src="{{item.img}}" title="{{item.name}}"
                                    width="30" height="30" />
                                <h4 class="item-name" data-action="toggle-description">{{item.name}}</h4>
                            </div>
                            <div class="item-controls">
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemEdit' }}" data-action="edit"><i
                                        class="fas fa-edit"></i></a>
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemDelete' }}" data-action="delete"><i
                                        class="fas fa-trash"></i></a>
                            </div>
                        </div>
                        <div class="item-description">
                            {{{item.system.enrichedDescription}}}
                        </div>
                    </li>
                    {{/if}}
                    {{/each}}
                </ol>
            </div>
        </div>

        <div class="tab loadout" data-group="primary" data-tab="loadout">
            {{!-- Owned Items Tab --}}
            <div class="features">
                <div class="tab-title">{{localize "DH.Loadout"}}</div>
                
                <div class="tab-category">{{localize "DH.Class"}}
                    <div class="category-controls">
                        <a class="item-control" title="{{ localize 'SIMPLE.ItemCreate' }}" data-action="create-class"
                            data-type="class">
                            <i class="fas fa-plus"></i></a>
                        <a class="item-control category-toggle" data-category="class" title="Toggle Class Section"><i class="fas fa-chevron-down"></i></a>
                    </div>
                </div>
                <ol class="item-list category-collapsed" data-item-type="class">
                    {{#each data.items as |item id|}}
                    {{#if (eq item.type "class")}}
                    <li class="item" data-item-id="{{item._id}}">
                        <div class="item-main-row">
                             <div class="item-top-row">
                                <img class="item-control" data-action="edit" src="{{item.img}}" title="{{item.name}}"
                                    width="30" height="30" />
                                <h4 class="item-name" data-action="toggle-description">{{item.name}}</h4>
                            </div>
                            <div class="item-controls">
                                <a class="item-control" title="{{localize "DH.SendToVault"}}" data-action="send-to-vault"><i
                                        class="fas fa-arrow-right"></i></a>
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemEdit' }}" data-action="edit"><i
                                        class="fas fa-edit"></i></a>
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemDelete' }}" data-action="delete"><i
                                        class="fas fa-trash"></i></a>
                            </div>
                        </div>
                        <div class="item-description">
                            {{{item.system.enrichedDescription}}}
                        </div>
                    </li>
                    {{/if}}
                    {{/each}}
                </ol>
                <div class="tab-category">{{localize "DH.Subclass"}}
                    <div class="category-controls">
                        <a class="item-control" title="{{ localize 'SIMPLE.ItemCreate' }}" data-action="create-subclass"
                            data-type="subclass">
                            <i class="fas fa-plus"></i></a>
                        <a class="item-control category-toggle" data-category="subclass" title="Toggle Subclass Section"><i class="fas fa-chevron-down"></i></a>
                    </div>
                </div>
                <ol class="item-list category-collapsed" data-item-type="subclass">
                    {{#each data.items as |item id|}}
                    {{#if (eq item.type "subclass")}}
                    <li class="item" data-item-id="{{item._id}}">
                        <div class="item-main-row">
                             <div class="item-top-row">
                                <img class="item-control" data-action="edit" src="{{item.img}}" title="{{item.name}}"
                                    width="30" height="30" />
                                <h4 class="item-name" data-action="toggle-description">{{item.name}}</h4>
                            </div>
                            <div class="item-controls">
                                <a class="item-control" title="Send to Vault" data-action="send-to-vault"><i
                                        class="fas fa-arrow-right"></i></a>
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemEdit' }}" data-action="edit"><i
                                        class="fas fa-edit"></i></a>
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemDelete' }}" data-action="delete"><i
                                        class="fas fa-trash"></i></a>
                            </div>
                        </div>
                        <div class="item-description">
                            {{{item.system.enrichedDescription}}}
                        </div>
                    </li>
                    {{/if}}
                    {{/each}}
                </ol>

                <div class="tab-category">{{localize "DH.Ancestry"}}
                    <div class="category-controls">
                        <a class="item-control" title="{{ localize 'SIMPLE.ItemCreate' }}" data-action="create-ancestry"
                            data-type="ancestry">
                            <i class="fas fa-plus"></i></a>
                        <a class="item-control category-toggle" data-category="ancestry" title="Toggle Ancestry Section"><i class="fas fa-chevron-down"></i></a>
                    </div>
                </div>
                <ol class="item-list category-collapsed" data-item-type="ancestry">
                    {{#each data.items as |item id|}}
                    {{#if (eq item.type "ancestry")}}
                    <li class="item" data-item-id="{{item._id}}">
                        <div class="item-main-row">
                             <div class="item-top-row">
                                <img class="item-control" data-action="edit" src="{{item.img}}" title="{{item.name}}"
                                    width="30" height="30" />
                                <h4 class="item-name" data-action="toggle-description">{{item.name}}</h4>
                            </div>
                            <div class="item-controls">
                                <a class="item-control" title="Send to Vault" data-action="send-to-vault"><i
                                        class="fas fa-arrow-right"></i></a>
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemEdit' }}" data-action="edit"><i
                                        class="fas fa-edit"></i></a>
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemDelete' }}" data-action="delete"><i
                                        class="fas fa-trash"></i></a>
                            </div>
                        </div>
                        <div class="item-description">
                            {{{item.system.enrichedDescription}}}
                        </div>
                    </li>
                    {{/if}}
                    {{/each}}
                </ol>
                
                <div class="tab-category">{{localize "DH.Community"}}
                    <div class="category-controls">
                        <a class="item-control" title="{{ localize 'SIMPLE.ItemCreate' }}" data-action="create-community"
                            data-type="community">
                            <i class="fas fa-plus"></i></a>
                        <a class="item-control category-toggle" data-category="community" title="Toggle Community Section"><i class="fas fa-chevron-down"></i></a>
                    </div>
                </div>
                <ol class="item-list category-collapsed" data-item-type="community">
                    {{#each data.items as |item id|}}
                    {{#if (eq item.type "community")}}
                    <li class="item" data-item-id="{{item._id}}">
                        <div class="item-main-row">
                             <div class="item-top-row">
                                <img class="item-control" data-action="edit" src="{{item.img}}" title="{{item.name}}"
                                    width="30" height="30" />
                                <h4 class="item-name" data-action="toggle-description">{{item.name}}</h4>
                            </div>
                            <div class="item-controls">
                                <a class="item-control" title="Send to Vault" data-action="send-to-vault"><i
                                        class="fas fa-arrow-right"></i></a>
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemEdit' }}" data-action="edit"><i
                                        class="fas fa-edit"></i></a>
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemDelete' }}" data-action="delete"><i
                                        class="fas fa-trash"></i></a>
                            </div>
                        </div>
                        <div class="item-description">
                            {{{item.system.enrichedDescription}}}
                        </div>
                    </li>
                    {{/if}}
                    {{/each}}
                </ol>

                <div class="tab-category">{{localize "DH.Abilities"}}
                    <div class="category-controls">
                        <a class="item-control" title="{{ localize 'SIMPLE.ItemCreate' }}" data-action="create"
                            data-type="item">
                            <i class="fas fa-plus"></i></a>
                        <a class="item-control category-toggle" data-category="abilities" title="Toggle Abilities Section"><i class="fas fa-chevron-down"></i></a>
                    </div>
                </div>
                <ol class="item-list category-collapsed" data-item-type="item">
                    {{#each data.items as |item id|}}
                    {{#if (eq item.type "item")}}
                    <li class="item" data-item-id="{{item._id}}">
                        <div class="item-main-row">
                            <div class="item-top-row">
                                <img class="item-control" data-action="edit" src="{{item.img}}" title="{{item.name}}"
                                    width="30" height="30" />
                                <h4 class="item-name" data-action="toggle-description">{{item.name}}</h4>
                            </div>
                            <div class="item-controls">
                                <a class="item-control" title="Send to Vault" data-action="send-to-vault"><i
                                        class="fas fa-arrow-right"></i></a>
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemEdit' }}" data-action="edit"><i
                                        class="fas fa-edit"></i></a>
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemDelete' }}" data-action="delete"><i
                                        class="fas fa-trash"></i></a>
                            </div>
                        </div>
                        <div class="item-description">
                            {{{item.system.enrichedDescription}}}
                        </div>
                    </li>
                    {{/if}}
                    {{/each}}
                </ol>

                <div class="tab-category">{{localize "DH.Vault"}}
                    <div class="vault-controls">
                        <a class="item-control" title="{{ localize 'SIMPLE.ItemCreate' }}" data-action="create-item"
                            data-type="vault">
                            <i class="fas fa-plus"></i></a>
                        <a class="item-control vault-toggle" title="{{localize "DH.ToggleVault"}}"><i class="fas fa-chevron-down"></i></a>
                    </div>
                </div>
                <ol class="item-list vault-collapsed" data-item-type="vault">
                    {{#each data.items as |item id|}}
                    {{#if (eq item.type "vault")}}
                    <li class="item" data-item-id="{{item._id}}">
                        <div class="item-main-row">
                            <div class="item-top-row">
                                <img class="item-control" data-action="edit" src="{{item.img}}" title="{{item.name}}"
                                    width="30" height="30" />
                                <h4 class="item-name" data-action="toggle-description">{{item.name}}</h4>
                            </div>
                            <div class="item-controls">
                                <!--<a class="item-control" title="Send to Domain" data-action="send-to-domain"><i
                                    class="fas fa-arrow-left"></i></a>-->
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemEdit' }}" data-action="edit"><i
                                        class="fas fa-edit"></i></a>
                                <a class="item-control" title="{{ localize 'SIMPLE.ItemDelete' }}" data-action="delete"><i
                                        class="fas fa-trash"></i></a>
                            </div>
                        </div>
                        <div class="item-description">
                            {{{item.system.enrichedDescription}}}
                        </div>
                    </li>
                    {{/if}}
                    {{/each}}
                </ol>
            </div>        
        </div>
    </section>

    <!-- Popup overlay for editing trait values -->
    <div class="trait-edit-popup-overlay" style="display: none;">
        <div class="trait-edit-popup">
            <div class="trait-edit-header">
                <span class="trait-edit-label"></span>
                <button type="button" class="trait-edit-close">Ã—</button>
            </div>
            <div class="trait-edit-content">
                <div class="trait-base-value">
                    <label>Base Value:</label>
                    <input type="number" class="trait-base-input" />
                </div>
                
                <div class="trait-modifiers-section">
                    <div class="modifiers-header">
                        <span>Additional Modifiers:</span>
                        <button type="button" class="add-modifier-btn">+</button>
                    </div>
                    <div class="modifiers-table">
                        <div class="modifiers-list"></div>
                    </div>
                </div>
                
                <div class="trait-total">
                    <label>Total Value:</label>
                    <span class="trait-total-value">0</span>
                </div>
            </div>
        </div>
    </div>
</form>
    